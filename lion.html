

<html>
<head>
	<title>My first Three.js app</title>
	<style>canvas { width: 100%; height: 100% }</style>
</head>
<body style="margin: 0px; padding: 0px;">
	<div id="canvas" style="margin: 0px; padding: 0px;">
	
	</div>
	<script src="libs/three.js/three.min.js"></script>
	<script type="text/javascript" src="./src/Potree.js"></script>
	<script type="text/javascript" >Potree.importScripts("./");</script>
	<script src="libs/three.js/OrbitControls.js"></script>
	<script>
		var renderer;
		var camera;
		var cube;
		var scene;
		var pscene;
		var canvas = document.getElementById("canvas");
		
		function initThree(){
			scene = new THREE.Scene();

			renderer = new THREE.WebGLRenderer({antialias: true});
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.shadowMapEnabled = true;
			var canvas = document.getElementById("canvas");
			canvas.appendChild(renderer.domElement);;
			camera = new THREE.PerspectiveCamera(75, canvas.clientWidth/canvas.clientHeight, 0.1, 1000);
			camera.position.z = 10;
			camera.position.y = 3;
			
			{ // cube
				var geometry = new THREE.CubeGeometry(8,0.6,8);
				var material = new THREE.MeshLambertMaterial({color: 0xaaaaa});
				cube = new THREE.Mesh(geometry, material);
				scene.add(cube);
				cube.position = new THREE.Vector3(-0.5,0.3,-1);
				cube.castShadow = true;
				cube.receiveShadow = true;
			}
			
			{ // spotlight
				var pointLight = new THREE.PointLight(0xffffff);
				pointLight.position.set(10, 10, 10);
				pointLight.shadowDarkness = 0.5;
				scene.add(pointLight);
			}
			
			{ // directional light with shadows
				var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
				directionalLight.position.set( 10, 10, 10 );
				directionalLight.target.position.set(0, 0, 0);
				directionalLight.castShadow = true;
				directionalLight.shadowDarkness = 0.5;
				directionalLight.shadowCameraNear = 0;
				directionalLight.shadowCameraFar = 30;
				 
				directionalLight.shadowCameraLeft = -8;
				directionalLight.shadowCameraRight = 8;
				directionalLight.shadowCameraTop = 8;
				directionalLight.shadowCameraBottom = -8;
				scene.add(directionalLight);
			}
			
			{ // plane
				var planeMaterial = new THREE.MeshLambertMaterial({color: 0xaaccdd});
				var plane = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), planeMaterial);
				plane.rotation.x = -Math.PI / 2;
				plane.overdraw = true;
				plane.receiveShadow = true;
				scene.add(plane);
			}
			
			controls = new THREE.OrbitControls(camera);
			controls.target.set( 0, 3, 0 );
			camera.lookAt(new THREE.Vector3(0,3,0));
			
			scene.add(createGrid(15, 15, 2));
		}
		
		function createGrid(width, length, spacing){
			var material = new THREE.LineBasicMaterial({
		        color: 0xBBBBBB
		    });
			
			var geometry = new THREE.Geometry();
		    for(var i = 0; i <= length; i++){
		    	 geometry.vertices.push(new THREE.Vector3(-(spacing*width)/2, 0, i*spacing-(spacing*length)/2));
				 geometry.vertices.push(new THREE.Vector3(+(spacing*width)/2, 0, i*spacing-(spacing*length)/2));
		    }
		    
		    for(var i = 0; i <= width; i++){
		    	 geometry.vertices.push(new THREE.Vector3(i*spacing-(spacing*width)/2, 0, -(spacing*length)/2));
				 geometry.vertices.push(new THREE.Vector3(i*spacing-(spacing*width)/2, 0, +(spacing*length)/2));
		    }
		    
		    var line = new THREE.Line(geometry, material, THREE.LinePieces);
		    line.receiveShadow = true;
		    return line;
		}
		
		function initPotree(){
			Potree.init(renderer.domElement);
			pscene = Potree.currentScene;
			
			// load pointcloud
			var cloudURL = "./resources/pointclouds/lion_takanawa/cloud.js";
			var pcoNode = POCLoader.load(cloudURL);
			
			// add to scene
			pscene.rootNode.addChild(pcoNode);
			pcoNode.scale(1,-1,1);
			pcoNode.rotateY(4);
			pcoNode.translate(-7,5,5);
			
			var material = MaterialManager.getMaterial("pointCloud");
			material.pointSize = 0.5;
//			material.renderMode = PointCloudRenderMode.FILTERED_SPLAT;
		}
		
		// the rendering loop
		function render() {
			requestAnimationFrame(render);

			// update aspect ratio and viewport size
			camera.aspect = renderer.domElement.clientWidth / renderer.domElement.clientHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(renderer.domElement.clientWidth, renderer.domElement.clientHeight);
			
			// render three.js scene
			renderer.render(scene, camera);
			
			// render potree scene
			Potree.renderer.viewport(0, 0, renderer.domElement.clientWidth, renderer.domElement.clientHeight);
			Potree.render(pscene, camera);
		};
		
		initThree();
		initPotree();
		render();
	</script>
	
	
</body>
</html>